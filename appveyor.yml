version: 1.0.0.{build}
pull_requests:
  do_not_increment_build_number: true
clone_depth: 1
environment:
  MY_BOOST_ROOT: C:\projects\boost
  MY_BOOST_INCLUDEDIR: C:\projects\boost
  MY_BOOST_LIBRARYDIR: C:\projects\boost\stage\lib
  matrix:
    - ID: minw32-x86-boost1.63
      GENERATOR: MinGW Makefiles
      BOOST_VERSION: 1_63_0
      BOOST_DOT_VERSION: 1.63.0
      MINGW_ROOT: C:\mingw-w64\i686-5.3.0-posix-dwarf-rt_v4-rev0\mingw32
      ADD_PATH: C:\mingw-w64\i686-5.3.0-posix-dwarf-rt_v4-rev0\mingw32\bin
      BOOST_TOOLSET: gcc
      ALLOW_FAILURE: no
      MY_Qt5Widgets_DIR: C:\Qt\5.10.0\mingw53_32\lib\cmake\Qt5Widgets

init:
- ps: Set-WinSystemLocale ru-RU
- ps: Start-Sleep -s 5
- ps: Restart-Computer
install:
- cmd: >-
    echo %PATH%

    set PATH=%PATH%;%ADD_PATH%

    cd ..

    curl -o boost.7z -L 
    https://sourceforge.net/projects/boost/files/boost/%BOOST_DOT_VERSION%/boost_%BOOST_VERSION%.7z/download

    7z x boost.7z

    rename boost_%BOOST_VERSION% boost

- cmd: >-
    cd boost

    .\bootstrap.bat

    .\b2.exe toolset=%BOOST_TOOLSET% --with-system --with-filesystem --with-regex --with-program_options

    cd %APPVEYOR_BUILD_FOLDER%

build_script:
- cmd: >-
    cmake -G "%GENERATOR%" -DBOOST_ROOT="%MY_BOOST_ROOT%"
    -DBOOST_LIBRARYDIR="%MY_BOOST_LIBRARYDIR%"
    -DBOOST_INCLUDEDIR="%MY_BOOST_INCLUDEDIR%"
    -DQt5Widgets_DIR="%MY_Qt5Widgets_DIR%"
    -DZLIB_INCLUDE_DIR="%MINGW_ROOT%\include"
    -DZLIB_LIBRARY="%MINGW_ROOT%\lib\libz.a" .

    cmake --build . --config Release

test_script:
- bin\Release\testproject.exe --reporter junit --out junit.xml

on_finish:
- ps: >-
    $wc = New-Object 'System.Net.WebClient'

    $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path .\junit.xml))

after_build:
- cmd: >-
    SET PATH=%PATH%;"%WIX%/bin"

    candle tool1cd.wxs

    light -out tool1cd-%APPVEYOR_BUILD_VERSION%.msi tool1cd.wixobj

artifacts:
- path: bin\Release\ctool1cd.exe
  name: ctool1cd.exe
- path: tool1cd-*.msi
  name: installer
deploy: off
